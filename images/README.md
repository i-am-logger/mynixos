# GitHub Actions Runner - NixOS Docker Image

A NixOS-based Docker image for GitHub Actions self-hosted runners, designed for use with Actions Runner Controller (ARC).

## Features

- **NixOS-based**: Built entirely with Nix packages for reproducibility
- **Nix-enabled**: Includes Nix with flakes support for building Nix projects
- **Comprehensive toolset**: Git, GCC, Docker CLI, and common CI/CD tools
- **ARC-compatible**: Works with GitHub Actions Runner Controller in Kubernetes
- **Ephemeral runners**: Configured for single-use, ephemeral execution

## Building

```bash
nix build /etc/nixos#github-runner-image
```

The result will be a Docker image tarball at `./result`.

## Loading into Docker

```bash
docker load < result
```

## Loading into Kubernetes/k3s

```bash
# Import to k3s
sudo k3s ctr images import result

# Or with containerd
sudo ctr -n k8s.io images import result
```

## Using with ARC

To use this custom image with your ARC runner scale sets, update the helm deployment in your NixOS configuration:

```nix
--set template.spec.containers[0].image="github-runner:nixos-latest"
```

See `Systems/Stacks/cicd/default.nix` or `modules/k3s-arc/default.nix` for integration.

## Included Packages

- **Core**: busybox, coreutils, bash, cacert
- **Build Tools**: gcc, gnumake, cmake, pkg-config, autoconf, automake, libtool
- **Languages**: Rust (rustc, cargo, rustfmt, clippy), Node.js 20
- **VCS**: git
- **Nix**: Full Nix installation with flakes enabled + nixpkgs-fmt
- **Container**: docker-client
- **GitHub**: gh CLI, CodeQL (for Copilot)
- **Libraries**: OpenSSL, zlib, libxml2, libxslt, sqlite
- **Utilities**: jq, yq, curl, wget, openssh, tar, gzip, xz, unzip, zip, bzip2

## Environment Variables

When running with ARC, the following environment variables are provided:

- `GITHUB_URL`: Repository or organization URL
- `RUNNER_TOKEN`: Registration token (auto-generated by ARC)
- `RUNNER_NAME`: Name of the runner instance

## Labels

Runners created from this image are tagged with:
- `nixos`
- `nix`

Use these in your workflow files:

```yaml
jobs:
  build:
    runs-on: [self-hosted, nixos]
    steps:
      - uses: actions/checkout@v4
      - run: nix build
```

## Automated Publishing to GHCR

The image is automatically built and published via GitHub Actions:

### Pre-release (on push to main)
- `ghcr.io/i-am-logger/github-runner:edge` - Latest main branch build
- `ghcr.io/i-am-logger/github-runner:sha-<commit>` - Specific commit SHA
- Installer ISO available as workflow artifact: `installer-iso-sha-<commit>`

### Release (via release-please)
When conventional commits are merged to main:
1. Release Please creates a PR with version bump and changelog
2. Release PR is automatically validated (runner image, installer ISO, system configs)
3. Once PR is merged and all checks pass, a release is created
4. Release artifacts are published:
   - `ghcr.io/i-am-logger/github-runner:<version>` - Versioned runner image (e.g., v0.1.0)
   - `ghcr.io/i-am-logger/github-runner:latest` - Latest stable runner image
   - Installer ISO attached to GitHub release

### Manual Publishing

If needed, you can manually build and push:

```bash
# Build the image
nix build /etc/nixos#github-runner-image

# Load into Docker
docker load < result

# Tag for GHCR
docker tag github-runner:nixos-latest ghcr.io/i-am-logger/github-runner:<tag>

# Push to GHCR
docker push ghcr.io/i-am-logger/github-runner:<tag>
```

## Testing

The image includes comprehensive automated tests. Run them locally:

```bash
nix build /etc/nixos#checks.x86_64-linux.github-runner-test
```

Tests verify:
- All tools are installed and working
- Rust builds complete successfully
- Node.js executes properly
- Git operations work
- Environment is correctly configured

See [TESTING.md](./TESTING.md) for detailed testing documentation.

## Customization

To add more packages or modify the configuration, edit `/etc/nixos/images/github-runner/default.nix`.

After making changes, rebuild:

```bash
nix build /etc/nixos#github-runner-image
```

Then run tests to verify:

```bash
nix build /etc/nixos#checks.x86_64-linux.github-runner-test
```
